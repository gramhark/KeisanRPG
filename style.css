:root {
    --bg-color: #0b0f19;
    /* Deep dark blue */
    --panel-color: #161b2e;
    --text-color: #ffffff;
    --primary-color: #4facfe;
    /* Light Blue */
    --accent-color: #ffd700;
    /* Gold */
    --danger-color: #ff4b4b;
    --success-color: #00e676;
    --border-color: #3b4259;
    --font-pixel: 'M PLUS Rounded 1c', sans-serif;
    --font-main: 'M PLUS Rounded 1c', sans-serif;
}

* {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
    user-select: none;
    -webkit-tap-highlight-color: transparent;
}

body {
    background-color: var(--bg-color);
    color: var(--text-color);
    font-family: var(--font-main);
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    /* フォールバック（古いブラウザ用） */
    min-height: 100dvh;
    /* ★追加: モバイルアドレスバー対応 */
    overflow: hidden;
    /* Prevent scroll on mobile */
}

#app {
    width: 100%;
    max-width: 100vw;
    height: 100vh;
    /* フォールバック（古いブラウザ用） */
    height: 100dvh;
    /* ★追加: モバイルアドレスバー対応 */
    background-color: var(--bg-color);
    position: relative;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    /* ★追加: ノッチ・ホームバー領域の回避 */
    padding-top: env(safe-area-inset-top, 0px);
    padding-bottom: env(safe-area-inset-bottom, 0px);
    padding-left: env(safe-area-inset-left, 0px);
    padding-right: env(safe-area-inset-right, 0px);
    box-sizing: border-box;
}

/* Screens */
.screen {
    display: none;
    flex-direction: column;
    height: 100%;
    width: 100%;
    padding: 20px;
}

.screen.active {
    display: flex;
}

/* Typography */
.title-img {
    max-width: 90%;
    height: auto;
    margin-top: 40px;
    display: block;
    margin-left: auto;
    margin-right: auto;
    filter: drop-shadow(0 0 4px rgba(255, 215, 0, 1));
}

.title {
    font-family: var(--font-pixel);
    font-size: 5rem;
    text-align: center;
    color: var(--accent-color);
    margin-top: 40px;
    text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
}

.subtitle {
    text-align: center;
    color: var(--primary-color);
    margin-bottom: 40px;
    font-size: 2rem;
}

/* Setup Form */
.setup-container {
    display: flex;
    flex-direction: column;
    gap: 24px;
    background: var(--panel-color);
    padding: 30px;
    border-radius: 16px;
    border: 1px solid var(--border-color);
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
}

.input-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: bold;
    color: #a0aabf;
    font-size: 1.5rem;
}

input[type="text"] {
    width: 100%;
    padding: 12px;
    border-radius: 8px;
    border: 2px solid var(--border-color);
    background: #0f1320;
    color: white;
    font-size: 2rem;
    text-align: center;
    outline: none;
}

input[type="text"]:focus {
    border-color: var(--primary-color);
}

.toggle-group,
.checkbox-group {
    display: flex;
    gap: 10px;
}

.toggle-btn,
.checkbox-btn {
    flex: 1;
    padding: 15px;
    background: #252b42;
    border: 2px solid var(--border-color);
    color: #888;
    border-radius: 8px;
    cursor: pointer;
    font-weight: bold;
    transition: all 0.2s;
    font-size: 1.8rem;
}

.toggle-btn.active,
.checkbox-btn.active {
    background: var(--primary-color);
    color: #fff;
    border-color: var(--primary-color);
    box-shadow: 0 0 10px rgba(79, 172, 254, 0.4);
}

.checkbox-btn {
    font-size: 1.5rem;
    /* Larger operators */
}

/* Buttons */
.primary-btn {
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    color: white;
    border: none;
    padding: 18px;
    border-radius: 50px;
    font-size: 2.5rem;
    font-weight: bold;
    cursor: pointer;
    box-shadow: 0 4px 15px rgba(0, 242, 254, 0.3);
    transition: transform 0.1s;
    margin-top: 20px;
}

.primary-btn:active {
    transform: scale(0.98);
}

/* Battle Screen */
#battle-screen {
    padding: 0;
}

.battle-view {
    flex: 1;
    min-height: 0;
    /* ★追加: flex子要素のオーバーフロー抑制 */
    display: flex;
    flex-direction: column;
    /* ★追加: 縦積みレイアウトを明示 */
    justify-content: center;
    align-items: center;
    position: relative;
    overflow: hidden;
    /* ★追加: はみ出し防止 */
    background: radial-gradient(circle at center, #1a2138 0%, #0b0f19 70%);
}

/* Stage Progress */
.stage-progress {
    position: absolute;
    /* Default: Overlay for landscape/standard */
    top: 10px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 8px;
    z-index: 5;
    background: rgba(0, 0, 0, 0.3);
    padding: 6px 12px;
    border-radius: 20px;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

/* Portrait Mode: Top Section (Sandwich Strategy) */
#app.portrait-mode .stage-progress {
    position: absolute;
    /* Overlay on top */
    top: 10px;
    left: 50%;
    transform: translateX(-50%);
    margin: 0;
    flex-shrink: 0;
}

#app.portrait-mode .result-img-container {
    width: 56px;
    height: 56px;
    border-radius: 50%;
    background: transparent;
    border: 2px solid rgba(255, 255, 255, 0.6);
    transition: all 0.3s;
}

/* 未戦闘: 中が透けた白丸（線だけ） */
.stage-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: transparent;
    border: 2px solid rgba(255, 255, 255, 0.6);
    transition: all 0.3s;
}

/* 戦闘中: 赤 */
.stage-dot.current {
    background: var(--danger-color);
    box-shadow: 0 0 8px var(--danger-color);
    border-color: #fff;
    transform: scale(1.2);
}

/* 通常モンスター戦闘後: 緑 */
.stage-dot.cleared {
    background: var(--success-color);
    border-color: var(--success-color);
    opacity: 0.7;
}

/* レアモンスター戦闘後: 黄 */
.stage-dot.cleared.rare {
    background: var(--accent-color);
    border-color: var(--accent-color);
    opacity: 0.7;
}

/* 回復モンスター戦闘後: 青 */
.stage-dot.cleared.heal {
    background: var(--primary-color);
    border-color: var(--primary-color);
    opacity: 0.7;
}

.monster-container {
    position: relative;
    display: flex;
    flex-direction: column;
    align-items: center;
    width: 100%;
}

#monster-img {
    max-width: 80%;
    max-height: 40vh;
    object-fit: contain;
    filter: drop-shadow(0 0 6px rgba(255, 255, 255, 1.5));
    transition: opacity 0.2s, filter 0.2s;
}

/* Damage Blink Effect */
@keyframes blink-damage {
    0% {
        opacity: 1;
    }

    25% {
        opacity: 0.2;
    }

    50% {
        opacity: 1;
    }

    75% {
        opacity: 0.2;
    }

    100% {
        opacity: 1;
    }
}

.flash-effect {
    animation: blink-damage 0.2s step-end;
}

/* Shake Effect */
@keyframes shake {
    0% {
        transform: translate(1px, 1px) rotate(0deg);
    }

    10% {
        transform: translate(-1px, -2px) rotate(-1deg);
    }

    20% {
        transform: translate(-3px, 0px) rotate(1deg);
    }

    30% {
        transform: translate(3px, 2px) rotate(0deg);
    }

    40% {
        transform: translate(1px, -1px) rotate(1deg);
    }

    50% {
        transform: translate(-1px, 2px) rotate(-1deg);
    }

    60% {
        transform: translate(-3px, 1px) rotate(0deg);
    }

    70% {
        transform: translate(3px, 1px) rotate(-1deg);
    }

    80% {
        transform: translate(-1px, -1px) rotate(1deg);
    }

    90% {
        transform: translate(1px, 2px) rotate(0deg);
    }

    100% {
        transform: translate(1px, -2px) rotate(-1deg);
    }
}

.shake-effect {
    animation: shake 0.5s;
}

.monster-stat {
    margin-top: 10px;
    text-align: center;
    width: 100%;
    max-width: 400px;
    position: relative;
    /* ★追加: z-index を有効にする */
    z-index: 10;
    /* ★追加: パネルより前面に表示 */
}

#monster-name {
    font-size: 1.8rem;
    font-weight: bold;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.8);
}

.hp-bar-container {
    width: 100%;
    background: #333;
    height: 10px;
    border-radius: 5px;
    overflow: hidden;
    margin-top: 5px;
    border: 1px solid #555;
    position: relative;
}

.hp-bar-container.small {
    height: 8px;
}

.hp-bar-fill {
    height: 100%;
    background: var(--success-color);
    transition: width 0.3s ease-out, background-color 0.3s;
}

/* Message Overlay — centered on monster */
.message-overlay {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 1.5rem;
    font-weight: bold;
    color: #fff;
    text-shadow: 0 0 8px #000, 0 0 16px #000;
    pointer-events: none;
    z-index: 10;
    width: 100%;
    text-align: center;
    white-space: pre-wrap;
    opacity: 0;
    transition: opacity 0.2s;
}

.message-overlay.show {
    opacity: 1;
}

.message-overlay.critical {
    color: var(--accent-color);
    font-size: 2rem;
    /* ぼかしを抑え、多方向に影を重ねてクッキリした白縁にする */
    text-shadow:
        2px 2px 2px #fff, -2px 2px 2px #fff, 2px -2px 2px #fff, -2px -2px 2px #fff,
        0px 2px 2px #fff, 0px -2px 2px #fff, 2px 0px 2px #fff, -2px 0px 2px #fff;
}

.message-overlay.damage {
    color: var(--danger-color);
    font-size: 1.8rem;
    /* ぼかしを最小限にし、多方向に重ねて太い黒縁にする */
    text-shadow:
        2px 2px 1px #000, -2px 2px 1px #000, 2px -2px 1px #000, -2px -2px 1px #000,
        0px 3px 2px #000, 0px -3px 2px #000, 3px 0px 2px #000, -3px 0px 2px #000;
}

/* Panel Area (Bottom) */
.panel {
    flex: 1;
    background: var(--panel-color);
    border-top: 4px solid var(--border-color);
    padding: 20px;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    position: relative;
    /* ★追加 */
    z-index: 5;
    /* ★追加: monster-stat より後ろ */
}

.status-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-family: var(--font-pixel);
    margin-bottom: 10px;
}

#player-name-display {
    font-size: 2rem;
}

.player-info {
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.sword-label {
    font-size: 1.1rem;
    color: var(--accent-color);
    font-family: var(--font-pixel);
    text-shadow: 0 0 6px rgba(255, 215, 0, 0.5);
}

/* Sword Drop Image */
.sword-drop-img {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    max-width: 60%;
    max-height: 35vh;
    object-fit: contain;
    filter: drop-shadow(0 0 10px rgba(255, 215, 0, 0.8));
    animation: sword-appear 0.5s ease-out;
    z-index: 5;
}

@keyframes sword-appear {
    0% {
        opacity: 0;
        transform: translate(-50%, -50%) scale(0.5);
    }

    100% {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1);
    }
}

#player-hp-text {
    font-size: 2rem;
    font-weight: bold;
}

.hp-status {
    display: flex;
    align-items: center;
    gap: 10px;
}

.hp-status .hp-bar-container {
    width: 100px;
    height: 14px;
}

/* Problem Area — single line: 12＋5＝□ */
.problem-area {
    text-align: center;
    margin: 10px 0;
}

.problem-text {
    font-size: 4rem;
    line-height: 1.3;
    min-height: 1.3em;
    font-weight: bold;
    color: var(--accent-color);
    font-family: var(--font-pixel);
    letter-spacing: 2px;
    display: flex;
    justify-content: center;
    align-items: baseline;
    flex-wrap: nowrap;
    white-space: nowrap;
    gap: 0;
}

.problem-text .answer-part {
    color: white;
    min-width: 1.5em;
    display: inline-block;
    border-bottom: 3px solid var(--primary-color);
    text-align: center;
    position: relative;
}

.problem-text .answer-part.empty::after {
    content: '';
    display: inline-block;
    width: 2px;
    height: 0.8em;
    background: white;
    animation: blink 1s infinite;
    vertical-align: baseline;
}

.input-wrapper {
    display: none;
}

.answer-input {
    background: transparent;
    border: none;
    color: white;
    font-size: 3rem;
    text-align: center;
    width: 200px;
    border-bottom: 2px solid var(--primary-color);
    font-family: var(--font-pixel);
    padding-bottom: 5px;
}

.answer-input:focus {
    outline: none;
}

/* Blinking Cursor */
.cursor {
    display: inline-block;
    width: 2px;
    height: 30px;
    background: white;
    position: absolute;
    top: 5px;
    right: 40px;
    /* Approximate */
    animation: blink 1s infinite;
}

@keyframes blink {
    50% {
        opacity: 0;
    }
}

/* Timer Bar */
.timer-container {
    width: 100%;
    height: 6px;
    background: #333;
    border-radius: 3px;
    overflow: hidden;
    margin-bottom: 15px;
}

.timer-bar {
    height: 100%;
    background: var(--success-color);
    /* Transition handled by JS or CSS animation */
}

/* Numpad */
.numpad {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 8px;
    height: 100%;
    padding-bottom: env(safe-area-inset-bottom, 8px);
}

.num-btn {
    background: #252b42;
    border: none;
    border-radius: 8px;
    color: white;
    font-size: 3rem;
    font-weight: bold;
    cursor: pointer;
    box-shadow: 0 4px 0 #0f1320;
    transition: transform 0.1s, box-shadow 0.1s;
    font-family: var(--font-pixel);
    padding: 10px 0;
}

.num-btn:active {
    transform: translateY(4px);
    box-shadow: 0 0 0 #0f1320;
}

.action-btn.red {
    background: var(--danger-color);
    box-shadow: 0 4px 0 #b30000;
}

.action-btn.green {
    background: var(--success-color);
    color: #000;
    box-shadow: 0 4px 0 #00b359;
}

/* Overlay (Interval) */
.overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.85);
    display: none;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 100;
    backdrop-filter: blur(5px);
    overflow: hidden;
    padding: 10px 0 30px;
    box-sizing: border-box;
}

.overlay.active {
    display: flex;
}

.overlay-content {
    text-align: center;
}

.overlay-content h2 {
    margin-bottom: 30px;
    font-family: var(--font-pixel);
    font-size: 2rem;
    text-align: center;
    line-height: 1.6;
}

/* Interval Image */
.interval-img {
    max-width: 500px;
    max-height: 500px;
    margin-bottom: 20px;
    filter: drop-shadow(0 0 6px rgba(255, 255, 255, 1.5));
    animation: bounce 2s infinite ease-in-out;
}

@keyframes bounce {

    0%,
    100% {
        transform: translateY(0);
    }

    50% {
        transform: translateY(-10px);
    }
}

/* 縦画面スマホ: 横幅を画面いっぱいに広げる */
@media screen and (max-width: 768px) {
    #app {
        max-width: 100vw;
        width: 100vw;
    }

    .screen {
        padding: 5px;
    }

    .setup-container {
        padding: 10px;
        width: 100%;
    }

    .title {
        font-size: 3rem;
        margin-top: 20px;
        margin-bottom: 20px;
    }

    .title-img {
        margin-top: 20px;
        margin-bottom: 20px;
    }



    .subtitle {
        font-size: 1.5rem;
        margin-bottom: 20px;
    }

    .panel {
        padding: 10px;
    }

    /* Interval Screen Fix */
    .overlay-content {
        width: 100%;
        padding: 0 5px;
    }

    .interval-img {
        max-width: 100%;
        height: auto;
    }

    .overlay-content h2 {
        width: 100%;
    }
}

/* Landscape / Tablet Support */
@media screen and (min-width: 800px) and (orientation: landscape) {
    #app {
        max-width: 1000px;
        flex-direction: row;
    }

    .screen {
        padding: 40px;
    }

    #battle-screen {
        flex-direction: row;
    }

    .battle-view {
        flex: 1;
        border-right: 2px solid var(--border-color);
    }

    .panel {
        flex: 1;
        border-top: none;
    }

    .numpad {
        gap: 12px;
    }

    .title {
        font-size: 4rem;
    }

    .title-img {
        max-width: 60%;
    }


    .title-img {
        max-width: 60%;
    }

    #monster-img {
        max-height: 450px;
        max-width: 100%;
    }

    /* Landscape: problem text slightly smaller to fit more digits */
    .problem-text {
        font-size: 3rem;
    }

    /* Landscape: numpad larger font */
    .num-btn {
        font-size: 3.5rem;
    }
}

/* Image Zoom Modal */
.image-modal {
    display: none;
    position: fixed;
    z-index: 200;
    padding-top: 50px;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgb(0, 0, 0);
    /* Fallback color */
    background-color: rgba(0, 0, 0, 0.9);
    /* Black w/ opacity */
}

.image-modal.active {
    display: block;
}

.modal-frame-wrapper {
    margin: auto;
    width: fit-content;
    max-width: 80%;
    max-height: 80vh;
    padding: 10px;
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
    /* Dark background */
    border: 4px solid #ffd700;
    /* Main Gold Border */
    border-radius: 12px;
    box-shadow:
        0 0 0 4px #b8860b,
        /* Darker Gold Outline */
        0 0 0 8px #1a1a2e,
        /* Dark Outer Space */
        0 0 20px rgba(255, 215, 0, 0.6),
        /* Gold Glow */
        inset 0 0 20px rgba(0, 0, 0, 0.8);
    /* Inner Shadow */
    position: relative;
    display: flex;
    justify-content: center;
    align-items: center;
    animation: zoom 0.3s;
}

/* Corner Decorations (Pseudo-elements) */
.modal-frame-wrapper::before,
.modal-frame-wrapper::after {
    content: '';
    position: absolute;
    width: 20px;
    height: 20px;
    background: #ffd700;
    border: 2px solid #b8860b;
    z-index: 2;
}

.modal-frame-wrapper::before {
    top: -6px;
    left: -6px;
    box-shadow: 4px 4px 0 #1a1a2e;
}

.modal-frame-wrapper::after {
    bottom: -6px;
    right: -6px;
    box-shadow: -4px -4px 0 #1a1a2e;
}

/* Add two more corners using inner div or just stick to 2 for style */

.modal-content {
    display: block;
    max-width: 100%;
    max-height: 70vh;
    /* Reduced to fit in frame */
    object-fit: contain;
    /* border-radius: 8px; */
    filter: drop-shadow(0 0 2px #fff) drop-shadow(0 0 5px rgba(255, 255, 255, 0.8)) drop-shadow(0 0 10px rgba(255, 255, 255, 0.4));
}

@keyframes zoom {
    from {
        transform: scale(0)
    }

    to {
        transform: scale(1)
    }
}

.close-modal {
    position: absolute;
    top: 15px;
    right: 35px;
    color: #f1f1f1;
    font-size: 40px;
    font-weight: bold;
    transition: 0.3s;
    cursor: pointer;
    z-index: 201;
}

.close-modal:hover,
.close-modal:focus {
    color: #bbb;
    text-decoration: none;
    cursor: pointer;
}

#caption {
    margin: auto;
    display: block;
    width: 80%;
    max-width: 700px;
    text-align: center;
    color: #ccc;
    padding: 10px 0;
    height: 150px;
    font-family: var(--font-pixel);
    font-size: 1.5rem;
}

/* Result Screen */
#result-screen {
    text-align: center;
    overflow-y: auto;
    padding-bottom: calc(20px + env(safe-area-inset-bottom, 20px));
}

.result-stats {
    background: var(--panel-color);
    padding: 20px;
    border-radius: 10px;
    margin: 20px 0;
    border: 1px solid var(--border-color);
}

#time-list {
    list-style: none;
    padding: 0;
    max-height: 500px;
    /* Increased slightly for grid */
    overflow-y: auto;

    /* Grid Layout */
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 15px;
    padding: 10px;
}

/* Result Card Styling */
.result-card {
    background: #1a2138;
    border: 2px solid var(--border-color);
    border-radius: 12px;
    padding: 10px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    text-align: center;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    transition: transform 0.2s;
}

.result-card:hover {
    transform: translateY(-2px);
    border-color: var(--primary-color);
}

.result-img-container {
    width: 80px;
    height: 80px;
    display: flex;
    justify-content: center;
    align-items: center;
    background: rgba(0, 0, 0, 0.2);
    border-radius: 50%;
    margin-bottom: 5px;
}

.result-img {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
    filter: drop-shadow(0 0 2px rgba(255, 255, 255, 0.5));
}

.result-info {
    display: flex;
    flex-direction: column;
    width: 100%;
}

.result-name {
    font-size: 0.9rem;
    color: #cbd5e1;
    margin-bottom: 4px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 100%;
}

.result-time {
    font-size: 1.2rem;
    font-weight: bold;
    color: white;
    font-family: var(--font-pixel);
}

.time-fastest {
    color: var(--success-color);
    /* Green for fastest now? or Keep Blue? Existing css had blue/cyan. Let's use Cyan/Green mix */
    color: #4facfe;
    text-shadow: 0 0 8px rgba(79, 172, 254, 0.8);
}

.time-slowest {
    color: var(--danger-color);
    text-shadow: 0 0 8px rgba(255, 75, 75, 0.8);
}

.result-total-container {
    text-align: center;
    margin: 20px 0;
    padding: 10px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 10px;
}

.total-label {
    display: block;
    font-size: 1.5rem;
    color: #ccc;
    margin-bottom: 5px;
}

.total-time-display {
    display: block;
    font-size: 4rem;
    font-weight: bold;
    color: var(--accent-color);
    font-family: var(--font-pixel);
    text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
}

.result-settings-container {
    text-align: center;
    margin-bottom: 20px;
    color: #a0aabf;
    font-size: 1.2rem;
    font-weight: bold;
    background: #252b42;
    padding: 10px;
    border-radius: 8px;
    border: 1px solid var(--border-color);
}

/* Footer / Copyright */
.setup-footer {
    margin-top: auto;
    text-align: center;
    padding: 20px 0;
    padding-bottom: calc(20px + env(safe-area-inset-bottom, 20px));
    color: #5a6275;
    font-size: 0.9rem;
    letter-spacing: 1px;
}

/* ============================================================
   PORTRAIT MODE — Mobile vertical stacking layout
   Activated by JS class .portrait-mode on #app
   ============================================================ */

/* --- App shell: force column, full viewport --- */
#app.portrait-mode {
    flex-direction: column;
    max-width: 100vw;
    width: 100vw;
    height: 100vh;
    /* フォールバック */
    height: 100dvh;
    /* ★追加 */
    transform: none !important;
}

/* --- Setup Screen (Portrait) --- */
#app.portrait-mode #setup-screen {
    padding: 6px 10px;
    overflow: hidden;
    justify-content: center;
}

#app.portrait-mode .title-img {
    max-width: 70%;
    margin-top: 6px;
    margin-bottom: 2px;
}

#app.portrait-mode .subtitle {
    font-size: 1rem;
    margin-bottom: 6px;
}

#app.portrait-mode .setup-container {
    padding: 10px;
    gap: 8px;
    width: 100%;
}

#app.portrait-mode .input-group label {
    font-size: 1rem;
    margin-bottom: 4px;
}

#app.portrait-mode input[type="text"] {
    font-size: 1.4rem;
    padding: 8px;
}

#app.portrait-mode .toggle-btn,
#app.portrait-mode .checkbox-btn {
    font-size: 1.1rem;
    padding: 8px 6px;
    min-height: 40px;
}

#app.portrait-mode .primary-btn {
    font-size: 1.5rem;
    padding: 10px;
    min-height: 46px;
    margin-top: 8px;
}

#app.portrait-mode .setup-footer {
    padding: 6px 0;
    padding-bottom: calc(6px + env(safe-area-inset-bottom, 16px));
    font-size: 0.7rem;
}

#app.portrait-mode #open-request-btn {
    width: 50%;
    margin: 10px auto;
    font-size: 0.8rem;
}

/* --- Battle Screen (Portrait): vertical stacking --- */
#app.portrait-mode #battle-screen {
    flex-direction: column;
    padding: 0;
    overflow: hidden;
    /* ★修正: スクロールせず1画面に収める */
    overflow-x: hidden;
}

/* Top area: monster visual — expanded */
#app.portrait-mode .battle-view {
    flex: 1 1 auto;
    min-height: 80px;
    border-right: none;
    border-bottom: 2px solid var(--border-color);
    padding: 0;
    overflow: hidden;
    position: relative;

    /* justify-content: center; から変更: モンスターを下に寄せつつ、完全にくっつかないよう余白を調整 */
    justify-content: flex-end;
    padding-bottom: 25px;
    /* ここで下側の隙間を調整（以前の半分程度に） */
    align-items: center;
}

#app.portrait-mode #monster-img {
    max-width: 80%;
    max-height: 30vh;
    /* ★修正: テンキーが収まるよう縮小 */
    object-fit: contain;
}

#app.portrait-mode .monster-stat {
    position: relative;
    left: auto;
    bottom: auto;
    width: 100%;
    z-index: 10;
    /* background: rgba(0, 0, 0, 0.4); Removed background */
    padding: 4px 0;
    flex-shrink: 0;
}

#app.portrait-mode #monster-name {
    font-size: 1.2rem;
    /* Increased from 0.9rem */
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.8);
    /* Maintain readability without plate */
}

#app.portrait-mode .stage-progress {
    top: 3px;
    padding: 3px 6px;
    gap: 4px;
}

#app.portrait-mode .stage-dot {
    width: 8px;
    height: 8px;
}

/* Bottom area: player status, problem, numpad — compact */
#app.portrait-mode .panel {
    flex: 0 1 auto;
    /* ★修正: shrink を許可 */
    border-top: none;
    padding: 6px 8px;
    padding-bottom: calc(env(safe-area-inset-bottom, 0px) + 6px);
    display: flex;
    flex-direction: column;
    overflow: visible;
    gap: 6px;
    min-height: 0;
    /* ★追加: flex子要素の縮小を許可 */
}

#app.portrait-mode .status-row {
    margin-bottom: 2px;
    flex-shrink: 0;
    white-space: nowrap;
    overflow: hidden;
}

#app.portrait-mode #player-name-display {
    font-size: clamp(1rem, 4vw, 1.5rem);
}

#app.portrait-mode #player-hp-text {
    font-size: clamp(1rem, 4vw, 1.5rem);
}

#app.portrait-mode .hp-status .hp-bar-container {
    width: 60px;
    height: 8px;
}

/* Problem area */
#app.portrait-mode .problem-area {
    margin: 10px 0;
    flex-shrink: 0;
}

#app.portrait-mode .problem-text {
    font-size: clamp(2.4rem, 8vw, 2.8rem);
    min-height: 1.3em;
    line-height: 1.4;
    white-space: nowrap;
    overflow: hidden;
}

#app.portrait-mode .answer-input {
    font-size: clamp(1rem, 5vw, 1.6rem);
    width: 120px;
}

#app.portrait-mode .input-wrapper {
    margin-top: 2px;
}

#app.portrait-mode .cursor {
    height: 20px;
    right: 25px;
}

/* Timer */
#app.portrait-mode .timer-container {
    margin-bottom: 4px;
    flex-shrink: 0;
    height: 5px;
}

/* Numpad — compact, larger font */
#app.portrait-mode .numpad {
    flex: 1 1 0;
    /* ★修正: 残りスペースを埋める */
    gap: 4px;
}

#app.portrait-mode .num-btn {
    font-size: clamp(2.2rem, 6vw, 2.6rem);
    min-height: 0;
    padding: 6px 0;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
}

/* Message overlay in portrait — centered on monster */
#app.portrait-mode .message-overlay {
    font-size: 1.4rem;
}

#app.portrait-mode .message-overlay.critical {
    font-size: 1.8rem;
}

/* --- Interval Overlay (Portrait) --- */
#app.portrait-mode .overlay-content {
    width: 90%;
    padding: 0 8px;
}

#app.portrait-mode .interval-img {
    max-width: 100%;
    max-height: 70vh;
    height: auto;
}

#app.portrait-mode .overlay-content h2 {
    font-size: 1.5rem;
    margin-bottom: 20px;
}

/* --- Result Screen (Portrait) --- */
#app.portrait-mode #result-screen {
    padding: 12px 10px;
    padding-bottom: env(safe-area-inset-bottom, 12px);
}

#app.portrait-mode #result-screen .title {
    font-size: 2.2rem;
    margin-top: 12px;
}

#app.portrait-mode .total-time-display {
    font-size: 2.8rem;
}

#app.portrait-mode .result-settings-container {
    font-size: 1rem;
}

#app.portrait-mode #time-list {
    grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
    gap: 8px;
    max-height: 40vh;
}

#app.portrait-mode .result-card {
    padding: 8px;
}

#app.portrait-mode .result-img-container {
    width: 56px;
    height: 56px;
}

/* Small Screen Optimization (e.g. iPhone SE) */
@media screen and (max-height: 700px) and (orientation: portrait) {
    #app.portrait-mode .panel {
        padding: 10px 10px calc(10px + env(safe-area-inset-bottom));
    }

    #app.portrait-mode .problem-text {
        font-size: 2.5rem;
        /* Smaller problem text */
        margin: 5px 0;
    }

    #app.portrait-mode .num-btn {
        padding: 4px 0;
        /* More compact buttons */
        font-size: 2rem;
    }

    #app.portrait-mode .status-row {
        margin-bottom: 5px;
    }

    #app.portrait-mode #player-name-display,
    #app.portrait-mode #player-hp-text {
        font-size: 1.5rem;
    }
}



/* --- Request Form (Portrait) --- */
#app.portrait-mode .button-group {
    flex-direction: row;
    gap: 10px;
    justify-content: center;
    margin-bottom: 20px;
    /* Add space at the bottom */
}

#app.portrait-mode #submit-request-btn {
    width: 45%;
    /* Use percentage to ensure equal width */
    min-width: unset;
    font-size: 1.0rem;
    padding: 12px 10px;
}

#app.portrait-mode .button-group .secondary-btn {
    width: 45%;
    /* Use percentage to ensure equal width */
    min-width: unset;
    margin-top: 0;
}

/* ============================================================
   モバイル Safe Area / dvh 互換性保証ブロック（末尾に追記）
   ============================================================ */

/* dvh 非対応ブラウザ向けフォールバック補完 */
@supports not (height: 100dvh) {
    body {
        min-height: -webkit-fill-available;
    }

    #app {
        height: -webkit-fill-available;
    }
}

/* safe-area-inset 非対応ブラウザ向けフォールバック */
@supports not (padding: env(safe-area-inset-bottom)) {
    #app {
        padding: 0;
    }

    #app.portrait-mode .panel {
        padding-bottom: 12px;
    }
}

/* Request Form */
.secondary-btn {
    background: transparent;
    border: 2px solid var(--border-color);
    color: #888;
    padding: 12px;
    border-radius: 50px;
    font-size: 0.9rem;
    font-weight: bold;
    cursor: pointer;
    margin-top: 10px;
    font-family: var(--font-pixel);
    transition: all 0.2s;
    width: 100%;
}

/* Specific override for the request button outside container */
#open-request-btn {
    margin-top: 20px;
    width: 100%;
    /* Default full width in landscape if outside, or handle in media query? */
    /* Let's keep it full width or auto in landscape context if needed?
       User didn't specify landscape width, but "outside container".
       It might look too wide if full screen width.
       Let's restrict max-width or let it be full width of setup container width if it was inside.
       But now it is child of #setup-screen directly.
    */
    max-width: 400px;
    /* Limit width so it doesn't span entire screen in landscape */
    display: block;
    margin-left: auto;
    margin-right: auto;
}

.secondary-btn:hover {
    color: white;
    border-color: var(--primary-color);
    background: rgba(255, 255, 255, 0.05);
}

.secondary-btn:active {
    transform: scale(0.98);
}

#request-overlay .overlay-content {
    background: var(--panel-color);
    padding: 20px;
    border-radius: 16px;
    border: 1px solid var(--border-color);
    width: 90%;
    max-width: 500px;
}

#request-text {
    width: 100%;
    height: 150px;
    background: #000;
    color: white;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 10px;
    font-family: var(--font-pixel);
    font-size: 16px;
    /* prevent iOS zoom */
    resize: none;
    margin-bottom: 20px;
    box-sizing: border-box;
}

#request-text:focus {
    outline: none;
    border-color: var(--primary-color);
}

/* Request Form Buttons (Landscape / Default) */
.button-group {
    display: flex;
    gap: 15px;
    justify-content: center;
    margin-top: 15px;
}

#submit-request-btn {
    margin-top: 0;
    font-size: 1.5rem;
    padding: 10px 30px;
    /* Reset from primary-btn if needed, but primary-btn has padding 18px */
    padding: 12px 30px;
}

/* Reset width for secondary button in group */
.button-group .secondary-btn {
    width: auto;
    margin-top: 0;
    padding: 12px 30px;
}

/* Horizontal Layout Adjustments (User Request) */
@media screen and (orientation: landscape) {

    /* 1. Make the 'Send Idea' button bigger */
    #open-request-btn {
        max-width: 500px;
        /* Increased from 400px */
        font-size: 1.5rem;
        /* Increased from 0.9rem */
        padding: 18px;
        /* Increased from 12px */
    }

    /* 2. Make the Submission Form bigger */
    #request-overlay .overlay-content {
        max-width: 700px;
        /* Increased from 500px */
        width: 80%;
        /* Ensure it takes up space */
        padding: 40px;
        /* Increased padding */
    }

    #request-text {
        height: 250px;
        /* Increased from 150px */
        font-size: 1.5rem;
        /* Larger text for better readability */
    }

    /* Adjust form buttons to match scale */
    #submit-request-btn,
    .button-group .secondary-btn {
        font-size: 1.4rem;
        padding: 15px 40px;
    }

    /* 3. Make the Text inside Submission Form bigger */
    #request-overlay .overlay-content h2 {
        font-size: 2.8rem;
        /* Increased from 2rem (default) or similar equivalent */
        margin-bottom: 25px;
        /* Adjust spacing */
    }

    #request-overlay .overlay-content p {
        font-size: 1.6rem !important;
        /* Override inline 0.9em (approx 1rem) */
        line-height: 1.6 !important;
        margin-bottom: 15px !important;
    }

    /* Target the last paragraph (Caution text) separately if needed, or let it scale up too. 
       The user wants BOTH distinct texts to be bigger. The last one is usually smaller. 
       Let's make the last one slightly smaller than the main text but still bigger than before.
    */
    #request-overlay .overlay-content p:last-of-type {
        font-size: 1.4rem !important;
        /* Override inline 0.85em */
        color: var(--danger-color);
        /* Maintain color just in case, though inline handles it */
    }
}