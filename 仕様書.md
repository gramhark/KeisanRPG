# 【開発仕様書】けいさんバトルRPG (マスバトール)

## 1. プロジェクト概要
* **プロジェクト名:** マスバトール 〜 けいさんバトルRPG 〜
* **目的:** ドラゴンクエスト風の戦闘画面を通じて、小学生が楽しく四則演算を学べるWebアプリケーション。
* **ターゲット:** スマートフォン、タブレット、PCブラウザ (縦画面・横画面 両対応の自動スケーリング)
* **技術スタック:** HTML5, CSS3, Vanilla JavaScript (フレームワーク不使用), LocalStorage API

## 2. ディレクトリ構成
```
KeisanRPG/
  ├── index.html      # アプリケーションのエントリーポイント
  ├── style.css       # スタイル定義（レスポンシブ対応）
  ├── script.js       # ゲームロジック
  ├── 仕様書.md       # 本ドキュメント
  └── assets/         # リソース
       ├── img/       # モンスター画像 (*.webp)
       ├── otherimg/  # アイテムやUI画像群
       ├── audio/     # 音声ファイル (*.mp3)
       └── monster_list.js # モンスターリストファイル
```

## 3. ゲームフローと画面仕様

### フェーズ1：タイトル・初期設定（Setup Screen）
* **入力項目:**
    1.  **勇者の名前:** 最大10文字（デフォルト: "ゆうしゃ"）。
        * 入力した名前はブラウザ（`localStorage`）に記憶され、次回アクセス時に自動入力される。
    2.  **左辺の桁数:** 1桁 / 2桁（トグルボタン選択）。
    3.  **右辺の桁数:** 1桁 / 2桁（トグルボタン選択）。
    4.  **計算の種類:** 足し算、引き算、掛け算、割り算（複数選択可）。
* **その他の機能:** 
    * **モンスターノート:** 過去に倒したモンスターの図鑑画面へ遷移する。
    * **アイデアをおくる:** Googleフォーム経由で要望やフィードバック等を送信するモーダルを開く。
* **開始:** 「バトルスタート」ボタン押下。

### フェーズ1B：モンスターノート（図鑑画面）
* **図鑑機能:** 過去のプレイで撃破したモンスターが記録される。
    * 未撃破の場合はシルエットと「？？？」で表示される。
    * 撃破済みの場合、クリック・タップで画像を拡大表示でき、**「最速クリアタイム」「合計撃破数」** が確認できる。
* **セーブ＆ロード（バックアップ機能）:** 図鑑データをJSONファイルとしてダウンロード（ほぞん）、およびアップロード（よみこむ）できる機能。チート対策（チェックサムによる改ざん防止）が組み込まれている。

### フェーズ2：インターバル（Interval Overlay）
* 次のモンスターの名称と画像を表示。
* 「たたかう」ボタンでバトル画面へ遷移。
* **BGM:**
    * 通常モンスター: `battle.mp3`
    * レアモンスター: `Rarebattle.mp3`
    * 回復モンスター: `Healbattle.mp3`
    * ラスボス（Stage 10）: `Bossbattle.mp3`

### フェーズ3：バトル画面（Battle Screen）
* **レイアウト・UI調整:**
    * **縦画面（スマホ: 800x1600ベース） / 横画面（PC: 1200x800ベース）:** 画面サイズに応じてUI全体が自動で拡大・縮小（スケーリング）される。
    * **名前表示の自動縮小:** キャラクター名が5文字以上の場合、操作パネル内でのレイアウト崩れを防ぐため文字サイズが動的に縮小表示される。
* **表示要素:**
    * モンスター画像、モンスターHPバー
    * ステージ進行度（上部のドット。クリア状況、レア、回復など色で判別）
    * 勇者ステータス（名前、装備中の剣・盾アイコン、プレイヤーHPバー: 最大10）
    * 制限時間バー（10秒）
    * 計算問題と入力フォーム
    * タッチ対応テンキー群、クリア（けす）、送信（いけ!）
* **操作と挙動:**
    * 物理キーボードまたは画面上のテンキーで回答。
    * 「いけ！」（ENTER）押下後、正誤判定のアニメーションやメッセージ表示中は、入力した回答が画面上に保持される。次の問題が出題される直前、またはミスからの復帰直後に自動でクリアされる。

### フェーズ4：リザルト画面（Result Screen）
* 全モンスター（通常10体）撃破時、またはゲームオーバー時に遷移。
* **クリア時演出:** 
    * 短いクリアSE（`clear.webm`）が鳴った後、**2.0秒後**に専用のクリアBGM（`clearBGM.webm`）がループ再生される。
* **合計タイム**、および各モンスターの**個別撃破タイム**一覧を表示。
    * それぞれ最速タイム（青色）と最遅タイム（赤色）がハイライトされる。
    * 各カードをクリックすると、モンスター画像の拡大モーダルが表示される。
* 「タイトルにもどる」ボタンで初期設定へ（縦画面ではボタンが目立つよう特大サイズ仕様）。

## 4. 詳細機能要件

### A. 計算ロジック
* **出題生成:** 設定された桁数と演算子に基づいてランダム生成。
* **割り算:** 必ず「割り切れる整数」が解となる問題のみ生成（余りなし）。また、答えが「1」や右辺が「1」になる問題は原則出題しない。
* **引き算:** 答えが「負の数」にならないよう、必ず `左辺 >= 右辺` に固定。

### B. バトルシステム
* **モンスター仕様:**
    * **ステージ数:** 読み込まれた画像ファイル数に応じて動的算出（基本は全10戦）。
    * **HP:** 原則モンスターの登場順番号に準拠（1体目はHP1、ラスボスは計算難易度に応じてHP10〜16など）。レア/回復モンスターはHP1固定。
    * **攻撃力:** 序盤1、中盤2、終盤3、ラスボス4。
* **クリティカル（タイムボーナス）:**
    * 出題から**3秒以内**に正解で**クリティカル（2ダメージベース）**。通常正解は1ダメージ。
* **プレイヤーHPと被ダメージ:**
    * 最大HP10。誤答時のみモンスターの攻撃力分のダメージを受ける（時間切れペナルティは無し）。
    * HP0でゲームオーバー。

### C. 装備アイテムとドロップシステム (剣・盾)
通常モンスター（レア・回復・ボス以外）を撃破した際、**剣**および**盾**がそれぞれ独立した確率でドロップすることがある。
**レアモンスター**撃破時は剣と盾を**必ず1段階アップグレード**する（最大レベル装備時を除く）。
**回復モンスター**撃破時は盾を**必ず1段階アップグレード**する（最大レベル装備時を除く）。
ドロップ時は [装備入手アニメーション] → [アイテム獲得(`item.mp3`)] → [装備完了(`equip.mp3`)] が自動で進行する。

* **剣（攻撃力プラス）:** レベルが上がるほど与ダメージが固定加算され、攻撃時のSEが剣専用（`swordattack.mp3`等）になる。
    1. **ぼう (Lv0):** 初期装備（ボーナス+0）。 ドロップ確率: Lv0→Lv1 (50%)
    2. **どうのつるぎ (Lv1):** ボーナス+1。 ドロップ確率: Lv1→Lv2 (25%)
    3. **てつのつるぎ (Lv2):** ボーナス+2。 ドロップ確率: Lv2→Lv3 (12%)
    4. **はがねのつるぎ (Lv3):** ボーナス+3。 これ以上のドロップなし。

* **盾（被ダメージ軽減）:** 誤答時のダメージを一定値軽減するが、軽減回数（耐久値）が存在。耐久値が0になると破壊される。
    * **未装備 (Lv0):** ドロップ確率: 未装備→Lv1 (30%)
    1. **きのたて (Lv1):** ダメージ軽減1 / 耐久1。 ドロップ確率: Lv1→Lv2 (20%)
    2. **どうのたて (Lv2):** ダメージ軽減2 / 耐久2。 ドロップ確率: Lv2→Lv3 (10%)
    3. **てつのたて (Lv3):** ダメージ軽減3 / 耐久3。 ドロップ確率: Lv3→Lv4 (5%)
    4. **はがねのたて (Lv4):** ダメージ軽減4 / 耐久4。 これ以上のドロップなし。
    * **破壊演出:** 耐久値が0になった攻撃を受けた時、「ダメージ表示＋盾ダメージ音(`shielddamage.mp3`)」が鳴り、1秒後に「こわれてしまった！＋専用破壊音（`crush.mp3`）」の2段階演出となる。

### D. 特殊イベント（バフ・特殊ボス）
1.  **レアモンスター:** ノーマル戦闘で低確率出現。撃破することで**攻撃力2倍**のバフを永続獲得。
2.  **回復モンスター:** プレイヤーHPが半分以下の時、一定確率で出現。登場時に「かいふくの チャンスだ！」というメッセージが表示される。撃破で**HP全回復**。
3.  **ボスモンスター（10戦目）:**
    * 桁設定や演算子数に応じてHPや種類が変化（Boss01〜16）。
    * **難易度アップ（難問出題機能）:**
        * ボス戦の「足し算・引き算」では、必ず「繰り上がり・繰り下がり」が発生する問題が最低保証される。
        * ボス戦の「掛け算」では、1桁なら6〜9、2桁なら50〜99と、大きな数値が出題されやすくなる。
        * ボス戦の「割り算」では、答えが必ず5以上になる。
    * **特殊イベント1（Boss 15 ティラノ系）:** 戦闘中、HPが5未満になると「肉を食べる」イベント（SE付き）。HPが16に全回復する。
    * **特殊イベント2（Boss 16 カブサムライ系）:**
        * ① HP6以下: 「樹液を舐める」イベント（SE付き）。HPが16に全回復。
        * ② HP4以下: 「真の姿（しんのかみ）」に変身。**最大HP20、現在HP20、攻撃力10**に変化し、画像と名前、BGM・SE（`lastboss.webm`等）が変わる超高難易度形態となる。

### E. 演出要件（VFX / Sound）
* **VFX（視覚効果）:**
    * 攻撃時: モンスターフラッシュ・点滅
    * 被ダメージ時: 画面全体シェイク
    * モンスター撃破時: フェードアウト
* **豊富に用意されたSE群:**
    * 基本: 通常攻撃 (`attack.mp3`), 通常クリティカル (`critical.mp3`), 被ダメ (`damage.mp3`), 撃破 (`defeat.mp3`), クリア (`clear.mp3`)
    * 装備・アイテム: 剣攻撃 (`swordattack.mp3`), 剣クリティカル (`swordcritical.mp3`), 盾被ダメ (`shielddamage.mp3`), 盾破壊 (`crush.mp3`), アイテム入手 (`item.mp3`), 装備時 (`equip.mp3`)
    * 特殊イベント: 回復 (`heal.mp3`), 肉食い (`meat.mp3`), 樹液 (`sap.mp3`), 変身 (`lastboss.mp3`)