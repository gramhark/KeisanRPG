# マスバトール - けいさんバトルRPG 仕様書

## 1. ゲーム概要
計算問題を解くことでモンスターと戦う、10連戦のバトルRPGです。プレイヤーは正しく、かつ素早く計算することでモンスターにダメージを与えます。
倒したモンスターからは経験値の代わりに装備や、ショップで使える通貨「マール」を入手し、全10ステージのクリアを目指します。

## 2. 画面とメニューの仕様

### 2.1 画面の自動調整（レスポンシブ）
* 画面の向き（縦向き・横向き）を自動で検知し、最適なレイアウトに調整されます。
* ブラウザのサイズに合わせて、常に画面中央にスケーリングして表示されます。

### 2.2 タイトル・ポータル画面
ゲームの入り口となる画面です。以下のメニューへアクセス可能です。
* **バトルへ**: セットアップ画面へ進みます。
* **モンスターノート**: 倒したモンスターの図鑑を確認できます。
* **アイテムノート**: 入手した装備や道具の図鑑を確認できます。
* **ショップ**: 貯めた「マール」を使ってアイテムを購入できます。
* **アイデアを おくる**: モンスターなどのアイデアを送信できるフォーム（Googleフォーム連携）が開きます。

### 2.3 セットアップ画面
ゲーム開始前に、以下の設定を行います。
* **なまえ**: プレイヤーの名前を入力します（最大10文字。入力内容は保存されます）。
* **ひだりのけた / みぎのけた**: 計算問題の左側と右側の数字の桁数（1けた・2けた）を選択します。これによりゲーム全体の難易度が決まります（選択状況は保存されます）。
* **けいさんのしゅるい**: 足し算（＋）、引き算（－）、掛け算（×）、割り算（÷）の中から、出題される計算の種類を複数選択できます（選択状況は保存されます）。

### 2.4 リザルト画面
全10戦をクリアすると表示されます。
* **合計タイム**: 全モンスターを倒すのにかかった合計時間が表示されます。
* **設定内容**: プレイ時の桁数や計算の種類が表示されます。
* **撃破タイム一覧**: 各モンスターごとの名前、画像、撃破タイムが表示されます。
    * 一番早かったタイムは「さいそくタイム」、遅かったタイムは「ワーストタイム」として強調されます。
* **画像拡大**: 各カードをタップすると、モンスターの画像が拡大され、最速撃破タイムや合計討伐数などの詳細な記録が表示されます。

### 2.5 モンスターノート（図鑑）
* 過去に倒したモンスターが一覧で表示されます。未討伐のモンスターはシルエットと「？？？」で表示されます。
* **カテゴリ分け**: ボス、とくべつ、かいふく、レア、およびステージ番号（1ばん〜10ばん）によって整理されます。
* **詳細記録**: 画像をタップすると、そのモンスターの「最速撃破タイム」と「合計討伐数」を確認できます。
* **バックアップ機能**:
    * **ほぞん（書き出し）**: 図鑑データ、所持マール、アイテム状況をJSON形式で保存できます。
    * **よみこむ（読み込み）**: 保存したファイルを読み込んで進行状況を復元できます。
    * **改ざん検知**: 保存データにはチェックサムが付与され、不正なデータの読み込みを検知します。

### 2.6 アイテムノート
* 入手した「けん」「たて」「どうぐ」がカテゴリ別に表示されます。
* 未入手のアイテムはシルエット表示となります。

## 3. バトルシステム

### 3.1 ターンの進行
バトルはプレイヤーとモンスターが交互に行動するターン制です。

* **プレイヤーのターン**:
    * **10秒間**のタイマーバーが表示されます。
    * 正解した場合、モンスターにダメージを与えます。回答時間が**3.0秒以内**だった場合は「クリティカル」となり、ダメージが増加します。
    * 不正解の場合、攻撃はミスとなり、モンスターのターンに移行します。
* **モンスターのターン**:
    * **20秒間**のタイマーバーが表示されます。
    * 正解した場合、モンスターの攻撃を「よけた」ことになり、ダメージを受けずに再びプレイヤーのターンに戻ります。
    * 不正解、または20秒経過した場合、モンスターからダメージを受けます。

### 3.2 アイテムの使用
* プレイヤーのターン中、画面の「かばん」アイコンをタップし、所持しているアイテムを選択して使用できます。
* 使用中（かばんを開いている間）はタイマーが一時停止します。

### 3.3 連続回避と必殺技（オーラ）
* モンスターターンの問題に正解（回避）するたびに、プレイヤーにオーラが溜まります。
* **4回連続**で回避するとオーラが最大（Lv.4）になり、「必殺技」が発動可能な状態になります。
* 必殺技待機状態でプレイヤーが正解すると、与えるダメージが**2倍**になります。
* **維持条件**: ダメージを受けたり時間切れになるとオーラはリセットされますが、**盾を装備している場合は、ダメージを軽減した際もオーラが維持されます。**

### 3.4 ダメージの計算
* **プレイヤーの攻撃**:
    * 計算式：`((1 × クリティカル補正) + 武器のボーナス + スペシャルボーナス) × 必殺技補正`
    * クリティカル（3.0秒以内）：基本ダメージが **2** になります（通常は1）。
    * 武器のボーナス：装備している剣のレベルに応じた加算値（+0 〜 +4）。
    * スペシャルボーナス：スペシャルモンスター（ミスターといし）を倒した回数、または「こうげきだま」の使用により加算。
    * 必殺技発動時：最終的なダメージを **2倍** にします。
* **モンスターの攻撃**:
    * 計算式：`モンスターの攻撃力 - 盾の軽減値 - 防御ボーナス`（最低0ダメージ）
    * 防御ボーナス：「ぼうぎょだま」の使用により加算されます。

## 4. 装備・アイテム・通貨

### 4.1 武器（けん）
通常モンスター討伐時、現在のレベルに応じて一定確率で次のレベルの剣をドロップします。

| レベル | 名称 | 攻撃ボーナス | 次レベルのドロップ率 |
| :--- | :--- | :--- | :--- |
| 0 | ぼう | +0 | 60% |
| 1 | どうのけん | +1 | 40% |
| 2 | てつのけん | +2 | 20% |
| 3 | はがねのけん | +3 | 10% |
| 4 | きんのけん | +4 | 4% |

### 4.2 防具（たて）
盾はダメージを軽減しますが、耐久度が0になると壊れます。通常モンスター討伐時、一定確率で次のレベルの盾をドロップします。盾装備中にダメージを軽減した場合、プレイヤーのオーラ（連続回避）はリセットされず維持されます。

| レベル | 名称 | 軽減値 | 耐久度 | 次レベルのドロップ率 |
| :--- | :--- | :--- | :--- | :--- |
| 0 | (なし) | - | - | 40% |
| 1 | きのたて | 1 | 1回 | 25% |
| 2 | どうのたて | 2 | 2回 | 15% |
| 3 | てつのたて | 3 | 3回 | 7% |
| 4 | はがねのたて | 4 | 4回 | 3% |
| 5 | きんのたて | 5 | 5回 | - |

### 4.3 消費アイテム（ショップで購入・かばん）
各アイテムは「かばん」内に最大10個まで持ち運ぶことができます。

| 名称 | 価格 | 効果 |
| :--- | :--- | :--- |
| かいふくだま | 600マール | HPを5回復する |
| こうげきだま | 1000マール | 攻撃ボーナスを+1する（永続） |
| ぼうぎょだま | 800マール | 防御ボーナスを+1する（1バトル中） |
| とげだま | 300マール | モンスターに3ダメージ与える |

### 4.4 通貨「マール」
* ボスモンスターを倒すことで入手できます。
* ボスごとに設定された額（100〜1000マール）がドロップします。
* 所持できるマールの上限は **99,999マール** です。

## 5. モンスターの仕様

### 5.1 ステータス表

| ステージ | モンスターHP | 攻撃力 |
| :--- | :--- | :--- |
| 1 | 1 | 1 |
| 2 | 3 | 1 |
| 3 | 4 | 1 |
| 4 | 5 | 2 |
| 5 | 7 | 2 |
| 6 | 8 | 2 |
| 7 | 9 | 3 |
| 8 | 11 | 3 |
| 9 | 12 | 4 |
| 10 (Boss) | 13 〜 20 | 4 〜 10 |

### 5.2 特殊な状態
* **いかり状態**: HPが30%未満になると、一定確率（通常5%、ボス10%）で発生。攻撃力が上昇（通常+1、ボス+2）し、ボスは専用のBGMに変化します。

### 5.3 特殊モンスター
* **レアモンスター**: プレイヤーのHPが60%以上の時に出現率2%。倒すと装備（剣・盾）を2段階上のものを確定ドロップ（上限を超える場合は1段階、またはドロップなし）。
* **回復モンスター**: プレイヤーのHPが低いほど出現率アップ（最大40%）。倒すとHP全回復し、盾の2段階上のものを確定ドロップ（上限調整あり）。
* **スペシャルモンスター (ミスターといし)**: プレイヤーのHPが60%以上の時に出現率5%（1ゲーム1回）。倒すと攻撃ボーナス+1。

### 5.4 ヤン系モンスターの解放
* 図鑑の登録状況に応じて、特定のシリーズ（ヤンダ→ヤンピ→...）が順次解放されます。
* 解放済みかつ未登録のモンスターは、出現の重みが通常の10倍になります。

### 5.5 ボスモンスターの特殊行動
* **ぼうくんティラノザ (Boss 15)**: HPが5未満になると「にく」を食べてHPを全回復します（1回のみ）。
* **じゅえきを嘗めるボス (Boss 16)**: HPが6以下になると「じゅえき」でHPを全回復します（1回のみ）。さらにHPが4以下になると「しんのかみ（ダイオウグソクナイト）」へ変身。HP 25、攻撃力 10の最強形態となります。
* **ヤンチヤントバーン (Boss 15)**: HPが5以下になると「気合」でHPを全回復します（1回のみ）。回復後さらにHPが5以下になると「ぼろぼろのヤンダ」に変化して攻撃力が 1 に激減します。

## 6. 計算問題の出題ロジック

### 6.1 基本仕様
* **引き算**: 答えがマイナスにならないよう、数値が自動的に入れ替わります。
* **割り算**: 
    * 答えが必ず整数（割り切れる）になります。
    * 答えは必ず2以上（ボスの場合は5以上）になります。

### 6.2 ボス専用ロジック
* **足し算・引き算**: 必ず「繰り上がり」または「繰り下がり」が発生する問題が選ばれます。
* **掛け算**: 数値の下限が引き上げられます（1けた：6-9、2けた：50-99）。

## 7. セーブデータの仕様
ローカルストレージに以下の情報を保存します。
* `math_battle_collection_v1`: モンスターの討伐記録（最速タイム、回数）。
* `math_battle_item_collection_v1`: アイテムの発見フラグ。
* `math_battle_gold`: 所持マール。
* `math_battle_bag`: 現在持ち運んでいる各アイテムの個数（かばんデータ）。
* その他、プレイヤー名や難易度設定など。
