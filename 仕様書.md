# マスバトール - けいさんバトルRPG 仕様書

## 1. ゲーム概要
計算問題を解くことでモンスターと戦う、10連戦のバトルRPGです。プレイヤーは正しく素早く計算することでモンスターにダメージを与え、全10ステージのクリアを目指します。

## 2. 画面とメニューの仕様

### 2.1 画面の自動調整（レスポンシブ）
* 画面の向き（縦向き・横向き）を自動で検知し、最適なレイアウトに調整されます。
* ブラウザのサイズに合わせて、常に画面中央にスケーリングして表示されます。

### 2.2 タイトル・セットアップ画面
ゲーム開始前に、以下の設定を行います。
* **なまえ**: プレイヤーの名前を入力します（最大10文字。入力内容は保存されます）。
* **ひだりのけた / みぎのけた**: 計算問題の左側と右側の数字の桁数（1けた・2けた）を選択します。これによりゲーム全体の難易度が決まります（選択状況は保存されます）。
* **けいさんのしゅるい**: 足し算（＋）、引き算（－）、掛け算（×）、割り算（÷）の中から、出題される計算の種類を複数選択できます（選択状況は保存されます）。

また、以下のサブメニューへアクセス可能です。
* **モンスターノート**: 倒したモンスターの図鑑を確認できます。
* **アイデアを おくる**: モンスターなどのアイデアを送信できるフォーム（Googleフォーム連携）が開きます。

### 2.3 リザルト画面
全10戦をクリアすると表示されます。
* **合計タイム**: 全モンスターを倒すのにかかった合計時間が表示されます。
* **撃破タイム一覧**: 各モンスターごとの名前、画像、撃破タイムが表示されます。一番早かったタイムは「さいそくタイム」として強調されます。
* **画像拡大**: 各カードをタップすると、モンスターの画像が拡大され、合計討伐数などの詳細な記録が表示されます。

### 2.4 モンスターノート（図鑑）
* 過去に倒したモンスターが一覧で表示されます。未討伐のモンスターはシルエットと「？？？」で表示されます。
* **カテゴリ分け**: ボス(Boss)、かいふく(Heal)、レア(Rare)、およびステージ番号（1ばん〜9ばん）によって自動で整理されます。
* **詳細記録**: 画像をタップすると、そのモンスターの「最速撃破タイム」と「合計討伐数」を確認できます。
* **バックアップ機能**:
    * **ほぞん（書き出し）**: 図鑑データをJSON形式でファイルとして保存できます。
    * **よみこむ（読み込み）**: 保存したファイルを読み込んで進行状況を復元できます。
* **改ざん検知**: 保存データにはチェックサムが付与され、不正なデータの読み込みを検知する機能があります。

## 3. バトルシステム

### 3.1 ターンの進行
バトルはプレイヤーとモンスターが交互に行動するターン制です。

* **プレイヤーのターン**:
    * **10秒間**のタイマーバーが表示されます。
    * 正解した場合、モンスターにダメージを与えます。回答時間が**3.0秒以内**だった場合は「クリティカル」となり、ダメージが増加します。
    * 不正解の場合、攻撃はミス（モンスターが回避）となり、モンスターのターンに移行します。
* **モンスターのターン**:
    * **20秒間**のタイマーバーが表示されます。
    * 正解した場合、モンスターの攻撃を「よけた」ことになり、ダメージを受けずに再びプレイヤーのターンに戻ります。
    * 不正解、または20秒経過した場合、モンスターからダメージを受けます。

### 3.2 連続回避と必殺技（オーラ）
* モンスターターンの問題に正解（回避）するたびに、プレイヤーにオーラが溜まります。
* **4回連続**で回避するとオーラが最大になり、「必殺技」が発動可能な状態になります。
* 必殺技待機状態でプレイヤーが正解すると、与えるダメージが**2倍**になります。
* **維持条件**: ダメージを受けたり時間切れになるとオーラはリセットされますが、**盾を装備している場合は、ダメージを軽減した際もオーラが維持されます。**

### 3.3 ダメージの計算
* **プレイヤーの攻撃**:
    * 計算式：`((1 × クリティカル補正) + 武器のボーナス + スペシャルボーナス) × 必殺技補正`
    * クリティカル（3.0秒以内）：基本ダメージが **2** になります（通常は1）。
    * 武器のボーナス：装備している剣のレベルに応じた加算値（+0 〜 +4）。
    * スペシャルボーナス：スペシャルモンスター（ミスターといし）を倒した回数につき **+1** 加算。
    * 必殺技発動時：最終的なダメージを **2倍** にします。
* **モンスターの攻撃**:
    * 計算式：`モンスターの攻撃力 - 盾の軽減値`（最低0ダメージ）

### 3.4 計算問題の出題仕様
* **足し算 / 引き算**: 指定した桁数でランダムに出題されます。引き算の答えがマイナスになることはありません。
* **掛け算**: 指定した桁数でランダムに出題されます。
* **割り算**: 
    * 答え（商）が必ず整数になる（割り切れる）問題が出題されます。
    * 答えは **2以上** になり、ボスの場合は難易度確保のため **5以上** になります。
* **ボスの問題**: 
    * 足し算・引き算は必ず「繰り上がり・繰り下がり」が発生する問題になります。
    * 掛け算は数値の下限が引き上げられます（1けた指定なら **6〜9**、2けた指定なら **50〜99**）。

## 4. 装備とアイテムドロップ
特定のモンスターを倒すと、武器（けん）や防具（たて）をドロップし、自動的に装備します。

### 4.1 武器（けん）
現在のレベルより高いレベルの剣をドロップします。

| レベル | 名称 | 攻撃ボーナス | 備考 |
| :--- | :--- | :--- | :--- |
| 0 | ぼう | +0 | 初期装備 |
| 1 | どうのけん | +1 | |
| 2 | てつのけん | +2 | |
| 3 | はがねのけん | +3 | |
| 4 | きんのけん | +4 | 最大レベル |

### 4.2 防具（たて）
盾はダメージを軽減しますが、攻撃を防ぐ（ダメージを受ける・時間切れになる）たびに耐久度が1減り、0になると壊れます。

| レベル | 名称 | 軽減値 | 耐久度 | 備考 |
| :--- | :--- | :--- | :--- | :--- |
| 1 | きのたて | 1 | 1回 | |
| 2 | どうのたて | 2 | 2回 | |
| 3 | てつのたて | 3 | 3回 | |
| 4 | はがねのたて | 4 | 4回 | |
| 5 | きんのたて | 5 | 5回 | 最大レベル |

### 4.3 ドロップ率
現在のレベルに応じて、次の段階の装備が落ちる確率が決まっています。

| 現在のレベル | 剣のドロップ率（次へ） | 盾のドロップ率（次へ） |
| :--- | :--- | :--- |
| なし / ぼう (L0) | 60% | 40% |
| レベル1 | 40% | 25% |
| レベル2 | 20% | 15% |
| レベル3 | 10% | 7% |
| レベル4 | 0% (最大) | 3% |
| レベル5 | - | 0% (最大) |

※ レア・回復モンスターは特殊な固定ドロップを持ちます（後述）。

## 5. モンスターの仕様と特殊行動

### 5.1 ステージ進行（HP・攻撃力）
モンスターのステータスは、ステージ番号（1〜10）によって決まります。

| ステージ | モンスターHP | 攻撃力 | 備考 |
| :--- | :--- | :--- | :--- |
| 1 | 1 | 1 | |
| 2 | 3 | 1 | |
| 3 | 4 | 1 | |
| 4 | 5 | 2 | |
| 5 | 7 | 2 | |
| 6 | 8 | 2 | |
| 7 | 9 | 3 | |
| 8 | 11 | 3 | |
| 9 | 12 | 4 | |
| 10 (Boss) | 13 〜 20 | 4 〜 7 | 設定（桁数・種類・項目数）により変動 |

* **いかり状態**: HPが30%未満になると、一定確率（通常5%、ボス10%）で「いかり」状態になります。攻撃力が **+1** (ボスは **+2**) 増加します。

### 5.2 特殊モンスター
* **レアモンスター (Rare_)**: 
    * 出現率: **2%**（ボス以外のステージ）。
    * ステータス: HP 1、攻撃力はステージ相当。
    * 特典: 倒すと剣・盾それぞれ **2段階上** の装備を確定ドロップします（存在しない場合は1段階上、それもなければなし）。
* **回復モンスター (Heal_)**: 
    * 出現率: プレイヤーの現在HPに応じて変動。
        * HP10: **0%**、HP5: **20%**、HP1: **40%** （計算式：`(10 - 現在HP) × 4% + α`）
    * ステータス: HP 1、攻撃力はステージ相当。
    * 特典: 倒すとプレイヤーのHPが **全回復** し、盾の **2段階上** を確定ドロップします。
* **スペシャルモンスター (Special_)**:
    * 名称: **ミスターといし**
    * 出現率: **5%**（1ゲームにつき最大1回、ボス以外のステージ）。
    * ステータス: HP 1、攻撃力 1。
    * 特典: 倒すと「武器のよさが上がった」と表示され、以後ゲーム終了まで蓄積される **スペシャルボーナス（ダメージ+1）** を獲得します。

### 5.3 ヤン系モンスターの解放と出現重み
* **段階的解放**: 図鑑の登録状況に応じて出現するようになります。
    * 出現順：ヤンダ → ヤンピ → ヤンチ → ヤント → ヤンダバーン → ヤンピバーン → ヤンチバーン → ヤントバーン → ヤンチヤントバーン
* **出現率の重み**: 出現条件を満たしており、かつ図鑑に未登録のヤン系モンスターは、通常の **10倍** 出現しやすくなります。

### 5.4 ボスモンスター（10戦目）の特殊行動
特定のボスは、HPが一定以下になると特殊な行動をとります。

* **ぼうくんティラノザ**:
    * HP 5未満になると「にく」を食べ、HPを全回復します（1回のみ）。
* **ボス16（こうてつカブトサムライ）**:
    * **じゅえき**: HP 6以下になると「じゅえき」を舐め、HPを全回復します（1回のみ）。
    * **変身**: HP 4以下（回復後、または回復をスキップした場合も含む）になると「しんのかみ」へと変身します。
    * **しんのかみ（変身後）**: **HP 25** に全回復し、攻撃力が **10** に上昇します。
* **ヤンチヤントバーン（ボス15）**:
    * **気合**: HP 5以下になると気合でHPを全回復します（1回のみ）。
    * **限界**: 全回復後、再びHP 5以下になると「ぼろぼろのヤンダ」に変化し、HPを全回復します。
    * **ぼろぼろのヤンダ（変化後）**: 攻撃力が **1** に大幅ダウンします。
