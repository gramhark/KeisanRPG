# マスバトール - けいさんバトルRPG 仕様書

## 1. ゲーム概要
計算問題を解くことでモンスターと戦う、10連戦のバトルRPGです。プレイヤーは正しく素早く計算することでモンスターにダメージを与え、全10ステージのクリアを目指します。

## 2. 画面とメニューの仕様

### 2.1 画面の自動調整（レスポンシブ）
* 画面の向き（縦向き・横向き）を自動で検知し、最適なレイアウトに調整されます。
* ブラウザのサイズに合わせて、常に画面中央にスケーリングして表示されます。

### 2.2 タイトル・セットアップ画面
ゲーム開始前に、以下の設定を行います。
* **なまえ**: プレイヤーの名前を入力します（最大10文字。入力内容は保存されます）。
* **ひだりのけた / みぎのけた**: 計算問題の左側と右側の数字の桁数（1けた・2けた）を選択します。これによりゲーム全体の難易度が決まります。
* **けいさんのしゅるい**: 足し算（＋）、引き算（－）、掛け算（×）、割り算（÷）の中から、出題される計算の種類を複数選択できます。

また、以下のサブメニューへアクセス可能です。
* **モンスターノート**: 倒したモンスターの図鑑を確認できます。
* **アイデアを おくる**: モンスターなどのアイデアを送信できるフォーム（Googleフォーム連携）が開きます。

### 2.3 リザルト画面
全10戦をクリアすると表示されます。
* **合計タイム**: 全モンスターを倒すのにかかった合計時間が表示されます。
* **撃破タイム一覧**: 各モンスターごとの名前、画像、撃破タイムが表示されます。一番早かったタイムは「さいそくタイム」として強調されます。
* **画像拡大**: 各カードをタップすると、モンスターの画像が拡大され、合計討伐数などの詳細な記録が表示されます。

### 2.4 モンスターノート（図鑑）
* 過去に倒したモンスターが一覧で表示されます。未討伐のモンスターはシルエットと「？？？」で表示されます。
* **カテゴリ分け**: ボス、かいふく、レア、およびステージ番号（1ばん〜9ばん）によって自動で整理されます。
* **詳細記録**: 画像をタップすると、そのモンスターの「最速撃破タイム」と「合計討伐数」を確認できます。
* **バックアップ機能**:
    * **ほぞん（書き出し）**: 図鑑データをJSON形式でファイルとして保存できます。
    * **よみこむ（読み込み）**: 保存したファイルを読み込んで進行状況を復元できます。
* **改ざん検知**: 保存データにはチェックサムが付与され、不正なデータの読み込みを検知する機能があります。

## 3. バトルシステム

### 3.1 ターンの進行
バトルはプレイヤーとモンスターが交互に行動するターン制です。

* **プレイヤーのターン**:
    * 10秒間のタイマーバーが表示されます。
    * 正解した場合、モンスターにダメージを与えます。回答時間が**3.0秒以内**だった場合は「クリティカル」となり、ダメージが増加します。
    * 不正解の場合、攻撃はミス（モンスターが回避）となり、モンスターのターンに移行します。
* **モンスターのターン**:
    * 20秒間のタイマーバーが表示されます。
    * 正解した場合、モンスターの攻撃を「よけた」ことになり、ダメージを受けずに再びプレイヤーのターンに戻ります。
    * 不正解、または20秒経過した場合、モンスターからダメージを受けます。

### 3.2 連続回避と必殺技（オーラ）
* モンスターターンの問題に正解（回避）するたびに、プレイヤーにオーラが溜まります。
* 4回連続で回避するとオーラが最大になり、「必殺技」が発動可能な状態になります。
* 必殺技待機状態でプレイヤーが正解すると、与えるダメージが**2倍**になります。
* **維持条件**: ダメージを受けたり時間切れになるとオーラはリセットされますが、**盾を装備している場合は、ダメージを軽減した際もオーラが維持されます。**

### 3.3 ダメージの計算
* **プレイヤーの攻撃**:
    * 計算式：`((基本1 × クリティカル補正) + 武器のボーナス) × 必殺技補正`
    * クリティカル（3秒以内）：補正として基本ダメージが2倍
    * 必殺技発動時：上記計算結果をさらに2倍
* **モンスターの攻撃**:
    * 計算式：`モンスターの攻撃力 - 盾の軽減値`（最低0ダメージ）

### 3.4 計算問題の出題仕様
* **足し算 / 引き算**: 指定した桁数でランダムに出題されます。引き算の答えがマイナスになることはありません。
* **掛け算**: 指定した桁数でランダムに出題されます。
* **割り算**: 必ず割り切れる問題が出題され、答え（商）は「2」以上になります（ボスの場合は「5」以上）。
* **ボスの問題**: 足し算・引き算は必ず「繰り上がり・繰り下がり」が発生する問題になります。また、掛け算は通常より大きな数字（1けたなら6〜9、2けたなら50〜99）が出題されやすくなります。

## 4. 装備とアイテムドロップ
特定のモンスターを倒すと、武器（けん）や防具（たて）をドロップし、自動的に装備します。

### 4.1 武器（けん）
現在の所持レベルより1段階上の剣をドロップします（レアモンスターは2段階上の場合あり）。
1. **ぼう**: ボーナス +0
2. **どうのけん**: ボーナス +1
3. **てつのけん**: ボーナス +2
4. **はガねのけん**: ボーナス +3
5. **きんのけん**: ボーナス +4

### 4.2 防具（たて）
盾はダメージを軽減しますが、攻撃を防ぐたびに耐久度が1減り、0になると壊れてなくなります。
1. **きのたて**: 軽減 1 / 耐久 1回
2. **どうのたて**: 軽減 2 / 耐久 2回
3. **てつのたて**: 軽減 3 / 耐久 3回
4. **はがねのたて**: 軽減 4 / 耐久 4回
5. **きんのたて**: 軽減 5 / 耐久 5回

### 4.3 ドロップ率（通常モンスター）
現在のレベルに応じて、次の段階の装備が落ちる確率が決まっています。

| 現在のレベル | 剣のドロップ率 | 盾のドロップ率 |
| :--- | :--- | :--- |
| なし / ぼう (L0) | 60% | 40% |
| レベル1 | 40% | 25% |
| レベル2 | 20% | 15% |
| レベル3 | 10% | 7% |
| レベル4 | 4% | 3% |
| レベル5 | - | 0% (最大) |

## 5. モンスターの仕様と特殊行動

### 5.1 ステージ進行（HP・攻撃力）
モンスターのステータスは、現在のステージ番号（1〜10）によって決まります。

| ステージ | モンスターHP | 攻撃力 | 備考 |
| :--- | :--- | :--- | :--- |
| 1 | 1 | 1 | |
| 2 | 3 | 1 | |
| 3 | 4 | 1 | |
| 4 | 5 | 2 | |
| 5 | 7 | 2 | |
| 6 | 8 | 2 | |
| 7 | 9 | 3 | |
| 8 | 11 | 3 | |
| 9 | 12 | 4 | |
| 10 (Boss) | 13 〜 20 | 4 〜 7 | 難易度（桁数・種類）により変動 |

### 5.2 特殊モンスター
* **レアモンスター**: 出現率 約2%。倒すと剣・盾のアップグレード（最大2段階）が確定でドロップします。
* **回復モンスター**: プレイヤーのHPが減っているほど出現率が上がります。
    * 出現率目安：HP1で約40%、HP5で20%、HP10で0%。
    * 倒すとプレイヤーのHPが全回復し、盾（最大2段階上）が確定でドロップします。
* **ヤン系モンスターの重み付け**: 出現条件を満たしており、かつ図鑑に未登録のヤン系モンスターは、他のモンスターより少し出現しやすくなります（重み 1.15倍）。

### 5.3 ヤン系モンスターの解放
特定のモンスター（ヤン系）は、図鑑の登録状況に応じて段階的に出現するようになります。
* 出現順：ヤンダ → ヤンピ → ヤンチ → ヤント → ヤンダバーン → ヤンピバーン → ヤンチバーン → ヤントバーン → ヤンチヤントバーン

### 5.4 ボスモンスター（10戦目）の特殊行動
特定のボスは、HPが減ると特殊な行動をとります。
* **ぼうくんティラノザ**: HP 5未満になると「にく」を食べ、HPを全回復します（一度のみ）。
* **ボス16の特殊行動**:
    * **じゅえき**: HP 6以下になると「じゅえき」を舐め、HPを全回復します（一度のみ）。
    * **変身**: HP 4以下になると、真の姿「しんのかみ」へと変身します。
    * **しんのかみ（変身後）**: HP 25に全回復し、攻撃力が 10 に上昇します。
* **ヤンチヤントバーン**:
    * 第1段階：HP 5以下になると気合でHPを全回復します。
    * 第2段階：全回復後、再びHP 5以下になると「ぼろぼろのヤンダ」に変化（弱体化：攻撃力1）し、HPを全回復します。